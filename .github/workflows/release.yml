name: Build and Release with Full Changelog

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      tag:
        description: '手动输入版本号 (例如: v1.0.0)'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write

jobs:
  build:
    name: Build for ${{ matrix.os }}
    strategy:
      matrix:
        # 定义三个平台的运行环境
        os: [windows-latest, macos-latest, ubuntu-latest]
        include:
          - os: windows-latest
            suffix: exe
          - os: macos-latest
            suffix: dmg
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Set Version and Tag
        id: vars
        shell: bash
        run: |
          # 判断是手动触发还是推送标签触发
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG_NAME="${{ github.event.inputs.tag }}"
          else
            TAG_NAME="${{ github.ref_name }}"
          fi
          
          VERSION=${TAG_NAME#v}
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Triggered Tag: $TAG_NAME"

      - name: Get previous tag
        id: prev_tag
        shell: bash
        run: |
          # 获取上一个标签，如果没有则取首个 commit
          PREV_TAG=$(git tag --sort=-v:refname | sed -n '2p')
          if [ -z "$PREV_TAG" ]; then
            PREV_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        shell: bash
        run: |
          PREV="${{ steps.prev_tag.outputs.prev_tag }}"
          REPO="${{ github.repository }}"
          # 生成日志到文件
          git log "$PREV..HEAD" --pretty=format:"* %s (%an) [%h](https://github.com/$REPO/commit/%H)" > changelog.txt

      - name: Run build
        run: npm run dist

      - name: Rename artifacts
        shell: bash
        run: |
          TAG="${{ steps.vars.outputs.tag }}"
          # 创建存放重命名后文件的目录
          mkdir -p final_artifacts
          
          if [ "${{ matrix.os }}" == "windows-latest" ]; then
            mv dist/*.exe "final_artifacts/xaml-translator-editor-$TAG.exe"
          elif [ "${{ matrix.os }}" == "macos-latest" ]; then
            mv dist/*.dmg "final_artifacts/xaml-translator-editor-$TAG.dmg" || mv dist/*.pkg "final_artifacts/xaml-translator-editor-$TAG.pkg"
          elif [ "${{ matrix.os }}" == "ubuntu-latest" ]; then
            mv dist/*.AppImage "final_artifacts/xaml-translator-editor-$TAG.AppImage" || mv dist/*.deb "final_artifacts/xaml-translator-editor-$TAG.deb"
          fi

      - name: Create or Update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          name: ${{ steps.vars.outputs.version }}
          body_path: changelog.txt
          draft: false
          prerelease: false
          # 自动匹配并上传重命名后的文件
          files: final_artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
